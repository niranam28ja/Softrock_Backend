"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
tslib_1.__exportStar(require("./creds"), exports);
const _got = require("got");
const qs = require("query-string");
const string_decoder_1 = require("string_decoder");
const utils_1 = require("./utils");
class MoneySpaceApiImpl {
    constructor(opts) {
        this.listeners = Array();
        this.opts = Object.assign(Object.assign({ currency: 'THB', feeType: 'include', gatewayType: 'card' }, opts), (!opts.baseUrl ? { baseUrl: 'https://www.moneyspace.net/merchantapi' } : null));
        this.got = _got.extend({
            baseUrl: this.opts.baseUrl,
            json: true,
            form: true
        });
    }
    get merchantApi() {
        return this;
    }
    sendPaymentTransaction(request) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const req = this.createEffectivePaymentRequest(request);
            const credentials = yield this.credentials();
            const timeHash = utils_1.createTimeHash();
            const hash = utils_1.hmacSHA256(credentials.secretKey, [
                req.firstName,
                req.lastName,
                req.email || '',
                req.phone || '',
                req.amount,
                req.currency,
                req.productDescription || '',
                req.address || '',
                req.message || '',
                req.feeType,
                timeHash,
                req.customerOrderId,
                req.gatewayType,
                req.successUrl,
                req.failUrl,
                req.cancelUrl
            ].join(''));
            const resp = yield this.got.post('v2/createpayment/obj', {
                body: Object.assign(Object.assign(Object.assign(Object.assign(Object.assign(Object.assign({ secreteID: credentials.secretId, firstname: req.firstName, lastname: req.lastName, amount: req.amount, currency: req.currency, feeType: req.feeType, timeHash, customer_order_id: req.customerOrderId, gatewayType: req.gatewayType, successUrl: req.successUrl, failUrl: req.failUrl, cancelUrl: req.cancelUrl }, (req.message && { message: req.message })), (req.address && { address: req.address })), (req.phone && { phone: req.phone })), (req.productDescription && { description: req.productDescription })), (req.email && { email: req.email })), { hash })
            });
            const payload = this.checkJSONResponse(resp);
            if (payload['Transaction ID'] == null) {
                throw new Error(payload.status);
            }
            const ret = {
                orderId: req.customerOrderId,
                transactionId: payload['Transaction ID'],
                timeHash
            };
            this.notifyWithEvent({
                status: 'PaymentSent',
                transactionId: ret.transactionId,
                orderId: ret.orderId,
                amount: req.amount,
                timeHash
            });
            return ret;
        });
    }
    checkPaymentTransaction(request) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const objRef = request.transactionId ? request.transactionId : request.orderId;
            if (objRef == null) {
                throw Error('`request` cannot be null');
            }
            const timeHash = utils_1.createTimeHash();
            const credentials = yield this.credentials();
            const resp = yield this.got.post(objRef === request.transactionId ? 'v1/findbytransaction/obj' : 'v1/findbyorderid/obj', {
                body: Object.assign(Object.assign({ secreteID: credentials.secretId }, (objRef === request.transactionId ? { transactionID: objRef } : { orderID: objRef })), { timeHash, hash: utils_1.hmacSHA256(credentials.secretKey, [objRef, timeHash].join('')) })
            });
            let payload = this.checkJSONResponse2(resp);
            payload = Object.keys(payload).reduce((pv, cv) => {
                pv[cv.toLowerCase().trim()] = `${payload[cv]}`;
                return pv;
            }, {});
            return Object.assign(Object.assign({ amount: payload['amount'] || '', statusPayment: payload['status payment'] || '', description: payload['description'] || '' }, (payload['transaction id'] ? { transactionId: payload['transaction id'] } : null)), (payload['order id'] ? { orderId: payload['order id'] } : null));
        });
    }
    getPaymentLink(transactionId) {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const timeHash = utils_1.createTimeHash();
            const credentials = yield this.credentials();
            const query = qs.stringify({
                secreteID: credentials.secretId,
                transactionID: transactionId,
                timehash: timeHash,
                hash: utils_1.hmacSHA256(credentials.secretKey, [transactionId, timeHash].join(''))
            });
            return `${this.opts.baseUrl}/makepayment/linkpaymentcard?${query}`;
        });
    }
    getMerchantProfile() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            const timeHash = utils_1.createTimeHash();
            const credentials = yield this.credentials();
            const resp = yield this.got.get('v1/store/obj', {
                query: qs.stringify({
                    secreteID: credentials.secretId,
                    timeHash,
                    hash: utils_1.hmacSHA256(credentials.secretKey, [timeHash, credentials.secretId].join(''))
                })
            });
            const payload = this.checkJSONResponse2(resp)['Store'] || [];
            return {
                stores: payload.map((s) => {
                    s = s || {};
                    return {
                        name: s.name || '',
                        logo: s.logo || '',
                        phone: s.telephone || ''
                    };
                })
            };
        });
    }
    registerApiEventListener(type, listener, once, transactionId) {
        if (Array.isArray(type)) {
            return type.map(t => this.registerApiEventListener(t, listener, once, transactionId));
        }
        this.listeners.push([type, listener, !!once, transactionId]);
        return listener;
    }
    unregisterApiEventListener(listenerReference) {
        if (Array.isArray(listenerReference)) {
            listenerReference.map(r => this.unregisterApiEventListener(r));
        }
        else {
            this.listeners = this.listeners.filter(el => el[1] != listenerReference);
        }
    }
    notifyWithEvent(event, transactionId) {
        const rmlist = new Array();
        try {
            this.listeners.forEach(l => {
                const [type, listener, once, tx] = l;
                if ((type == event.status || type == '*') && (tx == null || tx == transactionId)) {
                    listener(type, event);
                    if (once) {
                        rmlist.push(l);
                    }
                }
            });
        }
        finally {
            if (rmlist.length > 0) {
                this.listeners = this.listeners.filter(l => rmlist.indexOf(l) === -1);
            }
        }
    }
    checkJSONResponse(resp) {
        if (!Array.isArray(resp.body) ||
            resp.body[0] == null ||
            typeof resp.body[0] != 'object' ||
            typeof resp.body[0]['status'] != 'string') {
            throw new Error('Invalid API endpoint response');
        }
        return resp.body[0];
    }
    checkJSONResponse2(resp) {
        if (!Array.isArray(resp.body) || resp.body[0] == null || resp.body[0]['status'] != null) {
            const msg = (Array.isArray(resp.body) ? resp.body[0]['status'] : null) || 'Invalid API endpoint response';
            throw new Error(msg);
        }
        return resp.body[0];
    }
    checkPaymentRequest(req) {
        if (req.firstName == null) {
            throw new Error('Missing required `firstName` option');
        }
        if (req.lastName == null) {
            throw new Error('Missing required `lastName` option');
        }
        if (/^\d+\.\d{2}$/.exec(req.amount || '') == null) {
            throw new Error('Invalid format of `amount`');
        }
        if (['include', 'exclude'].indexOf(req.feeType || '') == -1) {
            throw new Error('Invalid `feeType` option');
        }
        if (req.customerOrderId == null) {
            throw new Error('Missing required `customerOrderId` option');
        }
        if (['card', 'qrnone'].indexOf(req.gatewayType || '') == -1) {
            throw new Error('Invalid `gatewayType` option');
        }
        if (req.gatewayType == 'card') {
            if (req.successUrl == null) {
                throw new Error('Missing required `successUrl` option');
            }
            if (req.failUrl == null) {
                throw new Error('Missing required `failUrl` option');
            }
            if (req.cancelUrl == null) {
                throw new Error('Missing required `cancelUrl` option');
            }
        }
        if (req.message && req.message.length > 100) {
            throw new Error('`message` option exceeded maximum allowed length of 100 characters');
        }
        if (req.gatewayType == 'qrnone' && req.productDescription == null) {
            throw new Error('For `qrnone` gateway require product description');
        }
        if (req.gatewayType == 'qrnone' && req.feeType != 'include') {
            throw new Error('For `qrnone` gateway feeType can be `include` only');
        }
        return req;
    }
    credentials() {
        return tslib_1.__awaiter(this, void 0, void 0, function* () {
            if (this._credentials) {
                return this._credentials;
            }
            const msc = this.opts.credentials;
            if (typeof msc == 'function') {
                this._credentials = yield msc();
            }
            else {
                this._credentials = msc;
            }
            return this._credentials;
        });
    }
    createEffectivePaymentRequest(input) {
        const req = Object.assign(Object.assign({}, this.opts), input);
        this.checkPaymentRequest(req);
        return req;
    }
    createWebHookRequestHandler() {
        return (req, resp) => {
            resp.statusCode = 200;
            if (req.method != 'POST') {
                resp.statusCode = 400;
                resp.end();
                return;
            }
            const sd = new string_decoder_1.StringDecoder('utf8');
            const data = new Array();
            req
                .on('data', chunk => data.push(sd.write(chunk)))
                .on('error', () => resp.end())
                .on('end', () => tslib_1.__awaiter(this, void 0, void 0, function* () {
                data.push(sd.end());
                const pq = qs.parse(data.join(''));
                const params = Object.keys(pq).reduce((pv, cv) => {
                    pv[cv.toLowerCase()] = `${pq[cv]}`;
                    return pv;
                }, {});
                const transactionId = params['transactionid'] != null ? params['transactionid'] : params['transectionid'];
                const orderId = params['orderid'];
                const amount = params['amount'];
                const hash = params['hash'];
                const status = params['status'];
                if (status == null || transactionId == null || amount == null) {
                    resp.statusCode = 400;
                    resp.end();
                    return;
                }
                const evt = {
                    transactionId,
                    orderId,
                    amount
                };
                switch (status.toLowerCase()) {
                    case 'ok':
                        evt.status = 'PaymentReceived';
                        break;
                    case 'pending':
                        evt.status = 'PaymentPending';
                        break;
                    case 'pay success':
                        evt.status = 'PaymentSuccess';
                        break;
                    case 'fail':
                        evt.status = 'PaymentFailed';
                        break;
                    case 'cancel':
                        evt.status = 'PaymentCancelled';
                        break;
                }
                const vbuf = [evt.transactionId, evt.amount];
                const credentials = yield this.credentials();
                if (evt.status != 'PaymentReceived') {
                    vbuf.push(status);
                    vbuf.push(evt.orderId);
                }
                const vhash = utils_1.hmacSHA256(credentials.secretKey, vbuf.join(''));
                if (vhash != hash) {
                    resp.statusCode = 400;
                    resp.end();
                    return;
                }
                resp.end();
                this.notifyWithEvent(evt, evt.transactionId);
            }));
        };
    }
}
function createMoneySpace(opts) {
    return new MoneySpaceApiImpl(opts);
}
exports.createMoneySpace = createMoneySpace;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9saWIvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQUEsa0RBQXdCO0FBQ3hCLDRCQUE0QjtBQUc1QixtQ0FBbUM7QUFDbkMsbURBQStDO0FBZ0IvQyxtQ0FBcUQ7QUFRckQsTUFBTSxpQkFBaUI7SUFDbkIsWUFBWSxJQUF1QjtRQW1CM0IsY0FBUyxHQUFHLEtBQUssRUFBZ0IsQ0FBQztRQWxCdEMsSUFBSSxDQUFDLElBQUksaUNBQ0wsUUFBUSxFQUFFLEtBQUssRUFDZixPQUFPLEVBQUUsU0FBUyxFQUNsQixXQUFXLEVBQUUsTUFBTSxJQUNoQixJQUFJLEdBQ0osQ0FBQyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUMsT0FBTyxFQUFFLHdDQUF3QyxFQUFDLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUNsRixDQUFDO1FBQ0YsSUFBSSxDQUFDLEdBQUcsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDO1lBQ25CLE9BQU8sRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU87WUFDMUIsSUFBSSxFQUFFLElBQUk7WUFDVixJQUFJLEVBQUUsSUFBSTtTQUNiLENBQUMsQ0FBQztJQUNQLENBQUM7SUFXRCxJQUFJLFdBQVc7UUFDWCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBRUssc0JBQXNCLENBQUMsT0FBK0I7O1lBRXhELE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUN4RCxNQUFNLFdBQVcsR0FBRyxNQUFNLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUM3QyxNQUFNLFFBQVEsR0FBRyxzQkFBYyxFQUFFLENBQUM7WUFFbEMsTUFBTSxJQUFJLEdBQUcsa0JBQVUsQ0FDbkIsV0FBVyxDQUFDLFNBQVMsRUFDckI7Z0JBQ0ksR0FBRyxDQUFDLFNBQVM7Z0JBQ2IsR0FBRyxDQUFD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