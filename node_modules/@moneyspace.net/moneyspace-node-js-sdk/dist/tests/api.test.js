"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const tslib_1 = require("tslib");
const ava_1 = require("ava");
const nock = require("nock");
const lib_1 = require("../lib");
const qs = require("query-string");
let nockScope;
function createApi() {
    return lib_1.createMoneySpace({
        credentials: lib_1.createSimpleCredentialsProvider('secret:e5e362183961480383d7a9662cbb3a5f', 'key:2e5475b2ea40440b94176f4c138d21d6'),
        successUrl: 'https://www.moneyspace.net/merchantapi/paycardsuccess',
        cancelUrl: 'https://www.moneyspace.net?status=cancel',
        failUrl: 'https://www.moneyspace.net?status=fail'
    });
}
ava_1.before(() => {
    nockScope = nock('https://www.moneyspace.net');
    nock.disableNetConnect();
});
ava_1.after(() => {
    nock.cleanAll();
    nock.enableNetConnect();
});
ava_1.default('mocked payment transaction', (t) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
    nockScope.post('/merchantapi/v2/createpayment/obj').reply(200, () => {
        return [
            {
                status: 'Create Success',
                'Transaction ID': 'MSTRF18000000017437'
            }
        ];
    });
    const api = createApi();
    const resp = yield api.merchantApi.sendPaymentTransaction({
        amount: '0.15',
        customerOrderId: 'f229c529d4c347449d6fb09c51b979a0',
        firstName: 'John',
        lastName: 'Doe'
    });
    t.is(resp.orderId, 'f229c529d4c347449d6fb09c51b979a0');
    t.is(resp.transactionId, 'MSTRF18000000017437');
    t.truthy(resp.timeHash);
}));
ava_1.default('mocked payment rejection', (t) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
    nockScope.post('/merchantapi/v2/createpayment/obj').reply(200, () => {
        return [
            {
                status: 'NotFound'
            }
        ];
    });
    const api = createApi();
    const err = yield t.throwsAsync(api.merchantApi.sendPaymentTransaction({
        amount: '0.15',
        customerOrderId: 'f229c529d4c347449d6fb09c51b979a0',
        firstName: 'John',
        lastName: 'Doe'
    }));
    t.is(err.message, 'NotFound');
}));
ava_1.default('mocked check payment transaction', (t) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
    nockScope.post('/merchantapi/v1/findbytransaction/obj').reply(200, (uri, requestBody) => {
        const body = qs.parse(requestBody.toString());
        return [
            {
                Amount: '100.25',
                'transaction ID': body.transactionID,
                'Status Payment': 'pending',
                Description: 'Tx description'
            }
        ];
    });
    const api = createApi();
    const resp = yield api.merchantApi.checkPaymentTransaction({
        transactionId: 'MSTRF18000000017437'
    });
    t.is(resp.transactionId, 'MSTRF18000000017437');
    t.is(resp.amount, '100.25');
}));
ava_1.default('mocked check payment transaction rejection', (t) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
    nockScope.post('/merchantapi/v1/findbytransaction/obj').reply(200, (uri, requestBody) => {
        return [
            {
                status: 'You cannot have permission to view this transaction.'
            }
        ];
    });
    const api = createApi();
    const err = yield t.throwsAsync(api.merchantApi.checkPaymentTransaction({
        transactionId: 'MSTRF18000000017437'
    }));
    t.is(err.message, 'You cannot have permission to view this transaction.');
}));
ava_1.default('mocked check order id', (t) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
    nockScope.post('/merchantapi/v1/findbyorderid/obj').reply(200, (uri, requestBody) => {
        const body = qs.parse(requestBody.toString());
        return [
            {
                Amount: '100.25',
                'Order ID': body.orderID,
                'Status Payment': 'pending',
                Description: 'Tx description'
            }
        ];
    });
    const api = createApi();
    const resp = yield api.merchantApi.checkPaymentTransaction({
        orderId: 'd8a3287c'
    });
    t.is(resp.orderId, 'd8a3287c');
    t.is(resp.amount, '100.25');
}));
ava_1.default('mocked check merchant profile', (t) => tslib_1.__awaiter(void 0, void 0, void 0, function* () {
    nockScope.get(/\/merchantapi\/v1\/store\/obj.*/).reply(200, () => {
        return [
            {
                Store: [
                    {
                        name: 'test store',
                        logo: 'https://moneyspace.s3-ap-southeast-1.amazonaws.com/1194_20190707220401917.jpeg',
                        telephone: '0999999903'
                    }
                ]
            }
        ];
    });
    const api = createApi();
    const resp = yield api.merchantApi.getMerchantProfile();
    t.true(resp.stores && Array.isArray(resp.stores));
    const store = resp.stores[0] || {};
    t.is(store.name, 'test store');
    t.is(store.logo, 'https://moneyspace.s3-ap-southeast-1.amazonaws.com/1194_20190707220401917.jpeg');
    t.is(store.phone, '0999999903');
}));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBpLnRlc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi90ZXN0cy9hcGkudGVzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSw2QkFBMEM7QUFDMUMsNkJBQTZCO0FBQzdCLGdDQUEyRTtBQUMzRSxtQ0FBbUM7QUFHbkMsSUFBSSxTQUFxQixDQUFDO0FBRTFCLFNBQVMsU0FBUztJQUNkLE9BQU8sc0JBQWdCLENBQUM7UUFDcEIsV0FBVyxFQUFFLHFDQUErQixDQUN4Qyx5Q0FBeUMsRUFDekMsc0NBQXNDLENBQ3pDO1FBQ0QsVUFBVSxFQUFFLHVEQUF1RDtRQUNuRSxTQUFTLEVBQUUsMENBQTBDO1FBQ3JELE9BQU8sRUFBRSx3Q0FBd0M7S0FDcEQsQ0FBQyxDQUFDO0FBQ1AsQ0FBQztBQUVELFlBQU0sQ0FBQyxHQUFHLEVBQUU7SUFDUixTQUFTLEdBQUcsSUFBSSxDQUFDLDRCQUE0QixDQUFDLENBQUM7SUFDL0MsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7QUFDN0IsQ0FBQyxDQUFDLENBQUM7QUFFSCxXQUFLLENBQUMsR0FBRyxFQUFFO0lBQ1AsSUFBSSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ2hCLElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0FBQzVCLENBQUMsQ0FBQyxDQUFDO0FBRUgsYUFBSSxDQUFDLDRCQUE0QixFQUFFLENBQU0sQ0FBQyxFQUFDLEVBQUU7SUFDekMsU0FBUyxDQUFDLElBQUksQ0FBQyxtQ0FBbUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUFFO1FBQ2hFLE9BQU87WUFDSDtnQkFDSSxNQUFNLEVBQUUsZ0JBQWdCO2dCQUN4QixnQkFBZ0IsRUFBRSxxQkFBcUI7YUFDMUM7U0FDSixDQUFDO0lBQ04sQ0FBQyxDQUFDLENBQUM7SUFFSCxNQUFNLEdBQUcsR0FBRyxTQUFTLEVBQUUsQ0FBQztJQUN4QixNQUFNLElBQUksR0FBRyxNQUFNLEdBQUcsQ0FBQyxXQUFX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